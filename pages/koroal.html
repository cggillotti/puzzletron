<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta http-equiv="X-UA-Compatible" content="ie=edge" />

<link rel="stylesheet"
href="https://cdnjs.cloudflare.com/ajax/libs/skeleton/2.0.4/skeleton.css"
integrity="sha256-ECB9bbROLGm8wOoEbHcHRxlHgzGqYpDtNTgDTyDz0wg=" crossorigin="anonymous" />

<link rel="stylesheet"
href="https://fonts.googleapis.com/css?family=Barriecito|Source+Sans+Pro:200&display=swap" />

<link rel="stylesheet"
href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
<script src="https://cdn.jsdelivr.net/npm/@shopify/draggable@1.0.0-beta.12/lib/draggable.bundle.js"></script>
<style>
    .zone {
        padding: 2rem;
        background-color: antiquewhite;
        border: black dotted;
    }

    .overlay{
    opacity:0.8;
    background-color:#ccc;
    position:fixed;
    width:100%;
    height:100%;
    top:0px;
    left:0px;
    z-index:1000;}

    .matrix {
        height: 20px;
        width: 20px;
        background: gray;
    border-radius: 50%;
    padding: 10px;

    }

    .active {
        background-color: hotpink;
    }
</style>

<!-- <link rel="stylesheet"
href="css/stylz.css" /> -->

<title>Untitled Document | Skeleton CSS</title>

<script lang="javascript">

 var state;
 const ws = new WebSocket('ws://localhost:3030');

    ws.onopen = () => { 
        console.log('Now connected'); 
    };

    const clientid =  Math.floor(Math.random() * 100);

    function getState() {
        let url = 'http://localhost:3000/matrix.json';
        

        fetch(url)
        .then(res => res.json())
        .then((out) => {
         console.log('Checkout this JSON! ', out);
            if(out && out.type === "gravedigger" && out.client != clientid)
            {
                state = out.state;
                setup();
            }
           
        })
        .catch(err => { throw err });

    }

function toggle(e) {
    if(e.classList.contains("active"))
        {
            e.classList.remove("active");
        } else {
            e.classList.add("active");
        }
}

function lazy(num) {
    console.log("num"+num);
    num = Number(num);
    switch(num) 
    {
        case 1:
            return "A";
        case 2:
            return "B";
        case 3: 
            return "C";
        case 4: 
            return "D";
        case 5:
            return "E";
        case 6: 
            return "F";
        case 7:
            return "G";

    }
    console.log("miss");
    return "";
}
    
   function setup() {
       console.log("setup "+ state);

       if(state) {
        state.forEach(item => {
            console.log("item:"+ item + "--" + item.id);
            if(item.class){
            document.querySelector("#"+ item.id).classList.add(item.class);
            }
        });
       }

       document.querySelectorAll('.matrix').forEach(e=> e.addEventListener('click',(ev) => {
         // var toChange = [e];
         var selector = "";
         toggle(e);
          if(e.dataset.row > 1) {
           console.log( e.dataset.row );
            selector = "#" + (lazy(Number(e.dataset.row - 1))) + e.dataset.col;
            toggle(document.querySelector(selector));
          }
          if(e.dataset.row  < 7) {
            selector = "#" + (lazy(Number(e.dataset.row) + 1)) + e.dataset.col;
            toggle(document.querySelector(selector));
          }
          if(e.dataset.col > 1) {
            selector = "#" + (lazy(e.dataset.row)) + (Number(e.dataset.col)-1);
            toggle(document.querySelector(selector));
          } 
          if(e.dataset.col < 7) {
            selector = "#" + (lazy(e.dataset.row)) + (Number(e.dataset.col)+1);
            toggle(document.querySelector(selector));
          }

       }));

    };

    function save() {
        var obj = {
            "type": "gravedigger",
            "client": clientid,
            state: []
        };
      
        var board = document.querySelectorAll(".matrix");
        for (var i=0;i<board.length;i++) {

            obj.state.push({id: board[i].id,class: board[i].classList.contains("active") ? "active":""});

        }
  
        console.log("Sending:" + obj);
        ws.send(JSON.stringify(obj));
    }

        ws.onmessage = (msg) => {
            console.log("Got:"+ msg.data);
            var template = "";
            var data = JSON.parse(msg.data);

            if(data.client && data.client !== clientid)
            {
                getState();
                return;
            }
        
        };

    window.onload = (event) => {
        getState();
    };

</script>
</head>
<body>
<div id="cover"></div>
    <div class="container">
        <h1> Entrance </h1>
        <div class="droppy">
        <div class=".one.columns">
            <table>
            <tr><td><button class="matrix" data-row="1" data-col="1" id="A1"></button></td><td><button class="matrix" data-row="1" data-col="2" id="A2"></button></td><td><button class="matrix" data-row="1" data-col="3" id="A3"></button></td><td><button class="matrix" data-row="1" data-col="4" id="A4"></button></td><td><button class="matrix" data-row="1" data-col="5" id="A5"></button></td><td><button class="matrix" data-row="1" data-col="6" id="A6"></button></td><td><button class="matrix" data-row="1" data-col="7" id="A7"></button></td></tr>
            <tr><td><button class="matrix" data-row="2" data-col="1" id="B1"></button></td><td><button class="matrix" data-row="2" data-col="2" id="B2"></button></td><td><button class="matrix" data-row="2" data-col="3" id="B3"></button></td><td><button class="matrix" data-row="2" data-col="4" id="B4"></button></td><td><button class="matrix" data-row="2" data-col="5" id="B5"></button></td><td><button class="matrix" data-row="2" data-col="6" id="B6"></button></td><td><button class="matrix" data-row="2" data-col="7" id="B7"></button></td></tr>
            <tr><td><button class="matrix" data-row="3" data-col="1" id="C1"></button></td><td><button class="matrix" data-row="3" data-col="2" id="C2"></button></td><td><button class="matrix" data-row="3" data-col="3" id="C3"></button></td><td><button class="matrix" data-row="3" data-col="4" id="C4"></button></td><td><button class="matrix" data-row="3" data-col="5" id="C5"></button></td><td><button class="matrix" data-row="3" data-col="6" id="C6"></button></td><td><button class="matrix" data-row="3" data-col="7" id="C7"></button></td></tr>
            <tr><td><button class="matrix" data-row="4" data-col="1" id="D1"></button></td><td><button class="matrix" data-row="4" data-col="2" id="D2"></button></td><td><button class="matrix" data-row="4" data-col="3" id="D3"></button></td><td><button class="matrix" data-row="4" data-col="4" id="D4"></button></td><td><button class="matrix" data-row="4" data-col="5" id="D5"></button></td><td><button class="matrix" data-row="4" data-col="6" id="D6"></button></td><td><button class="matrix" data-row="4" data-col="7" id="D7"></button></td></tr>
            <tr><td><button class="matrix" data-row="5" data-col="1" id="E1"></button></td><td><button class="matrix" data-row="5" data-col="2" id="E2"></button></td><td><button class="matrix" data-row="5" data-col="3" id="E3"></button></td><td><button class="matrix" data-row="5" data-col="4" id="E4"></button></td><td><button class="matrix" data-row="5" data-col="5" id="E5"></button></td><td><button class="matrix" data-row="5" data-col="6" id="E6"></button></td><td><button class="matrix" data-row="5" data-col="7" id="E7"></button></td></tr>
            <tr><td><button class="matrix" data-row="6" data-col="1" id="F1"></button></td><td><button class="matrix" data-row="6" data-col="2" id="F2"></button></td><td><button class="matrix" data-row="6" data-col="3" id="F3"></button></td><td><button class="matrix" data-row="6" data-col="4" id="F4"></button></td><td><button class="matrix" data-row="6" data-col="5" id="F5"></button></td><td><button class="matrix" data-row="6" data-col="6" id="F6"></button></td><td><button class="matrix" data-row="6" data-col="7" id="F7"></button></td></tr>
            <tr><td><button class="matrix" data-row="7" data-col="1" id="G1"></button></td><td><button class="matrix" data-row="7" data-col="2" id="G2"></button></td><td><button class="matrix" data-row="7" data-col="3" id="G3"></button></td><td><button class="matrix" data-row="7" data-col="4" id="G4"></button></td><td><button class="matrix" data-row="7" data-col="5" id="G5"></button></td><td><button class="matrix" data-row="7" data-col="6" id="G6"></button></td><td><button class="matrix" data-row="7" data-col="7" id="G7"></button></td></tr>


            </table>
        </div>
    </div>
</div>
</body>
</html>